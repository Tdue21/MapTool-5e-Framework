<!DOCTYPE html>
<html>

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link  rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&display=swap">

    <script src="../scripts/libraries/vue.global-3.4.15.js"></script>
    <script src="../scripts/libraries/marked.umd.min-4.0.18.js"></script>
    <script src="../scripts/mt-tools.js?libcache=false"></script>
    <script src="../scripts/constants.js?libcache=false"></script>

    <title>Statblock</title>
    <style>
        :root {
            font-family: "Noto Sans";
            font-size: 15px;
            background-color: #f9f4d9;
        }

        .separator {
            display: block;
            margin: 0px;
            margin-top: 5px;
            margin-bottom: 5px;
            width: 100%;
            height: 5px;
            padding: 0px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 226.08 3'%3E%3Cdefs%3E%3Cstyle%3E.cls-1%7Bfill:none;%7D.cls-2%7Bclip-path:url(%23clip-path);%7D.cls-3%7Bfill:%239b2818;%7D%3C/style%3E%3CclipPath id='clip-path' transform='translate(-666 -479)'%3E%3Crect class='cls-1' x='666' y='479' width='226.08' height='3'/%3E%3C/clipPath%3E%3C/defs%3E%3Ctitle%3Estat-block-header-bar%3C/title%3E%3Cg class='cls-2'%3E%3Cpath class='cls-3' d='M666,482c5.76,0,226.08-1.5,226.08-1.5S671.76,479,666,479Z' transform='translate(-666 -479)'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left;
            background-size: 90%;
        }

        #abilities {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-between;
        }

        .ability-block {
            text-align: center;
        }

        .ability-header {
            font-weight: bold;
        }

        #tokenImage {
            width: 64px;
            height: 64px;
            transition: transform .2s;
            transform-origin: top right;
        }

        #tokenImage:hover {
            transform: scale(5);
            transform-origin: top right;
            transition: transform .2s;
        }
    </style>
</head>

<body>
    <div id="app" style="z-index: 0;">

        <section id="header" style="display: flex; gap: 5px">
            <div style="align-self: stretch;">
                <h1>{{npc.name}}</h1>
                <span style="font-style: italic;">{{getSize(npc.settings)}} {{npc.type}}, {{npc.alignment}}</span>
            </div>

            <div style="align-self: end; margin-left: auto;">
                <img id="tokenImage" :src="getImage(npc.name)" :alt="npc.name" width="64" :title="npc.name">
            </div>
        </section>

        <div class="separator"></div>

        <section id="attributes">
            <div style="display:flex;gap: 25px">
                <div><b>Armor Class</b> {{npc.ac}}</div>
                <div><b>Initiative</b> {{getInitiative(npc)}}</div>
            </div>
            <div><b>Hit Points</b> {{npc.hp}}</div>
            <div><b>Speed</b> {{npc.speed}}</div>
        </section>

        <div class="separator"></div>

        <section id="abilities">
            <div class="ability-block">
                <div class="ability-header">STR</div>
                <div class="ability-data">
                    <span>{{npc.str}}</span>
                    <span>{{calcMod(npc.str)}}</span>
                </div>
            </div>

            <div class="ability-block">
                <div class="ability-header">DEX</div>
                <div class="ability-data">
                    <span>{{npc.dex}}</span>
                    <span>{{calcMod(npc.dex)}}</span>
                </div>
            </div>

            <div class="ability-block">
                <div class="ability-header">CON</div>
                <div class="ability-data">
                    <span>{{npc.con}}</span>
                    <span>{{calcMod(npc.con)}}</span>
                </div>
            </div>

            <div class="ability-block">
                <div class="ability-header">INT</div>
                <div class="ability-data">
                    <span>{{npc.int}}</span>
                    <span>{{calcMod(npc.int)}}</span>
                </div>
            </div>

            <div class="ability-block">
                <div class="ability-header">WIS</div>
                <div class="ability-data">
                    <span>{{npc.wis}}</span>
                    <span>{{calcMod(npc.wis)}}</span>
                </div>
            </div>

            <div class="ability-block">
                <div class="ability-header">CHA</div>
                <div class="ability-data">
                    <span>{{npc.cha}}</span>
                    <span>{{calcMod(npc.cha)}}</span>
                </div>
            </div>

        </section>

        <div class="separator"></div>

        <section id="tidbits">
            <div v-if="hasValue(npc.save)"><b>Saving Throws</b> {{npc.save}}</div>
            <div v-if="hasValue(npc.skill)"><b>Skills</b> {{npc.skill}}</div>
            <div v-if="hasValue(npc.DamageVulnerabilities)"><b>Damage Vulnerabilities</b> {{npc.DamageVulnerabilities}}
            </div>
            <div v-if="hasValue(npc.DamageResistences)"><b>Damage Resistances</b> {{npc.DamageResistences}}</div>
            <div v-if="hasValue(npc.DamageImmunities)"><b>Damage Immunities</b> {{npc.DamageImmunities}}</div>
            <div v-if="hasValue(npc.ConditionImmunities)"><b>Condition Immunities</b> {{npc.ConditionImmunities}}</div>
            <div v-if="hasValue(npc.senses)"><b>Senses</b> {{npc.senses}}</div>
            <div v-if="hasValue(npc.languages)"><b>Languages</b> {{npc.languages}}</div>
            <div style="display:flex;gap: 25px">
                <div><b>Challenge</b> {{npc.challenge}}</div>
                <div><b>Proficiency Bonus</b> {{calcProfBonus(npc.challenge)}}</div>
            </div>
        </section>

        <div class="separator"></div>

        <section id="traits" v-if="hasValue(npc.feats.Features)">
            <h2>Traits</h2>
            <div v-html="renderMarkdown(npc.feats.Features)"></div>
        </section>


        <section id="actions" v-if="hasValue(npc.actions.Actions)">
            <h2>Actions</h2>
            <div v-html="renderMarkdown(npc.actions.Actions)"></div>
        </section>

        <div class="separator"></div>

        <section id="legendary" v-if="hasValue(npc.actions['Legendary Actions'])">
            <h2>Legendary Actions</h2>
            <div v-html="renderMarkdown(npc.actions['Legendary Actions'])"></div>
        </section>

        <div>
            <span>Source: {{ npc.sources.join(", ") }}</span>
        </div>
    </div>
</body>


<script>
    "use strict";

    const { createApp } = Vue;
    createApp({
        data() {
            return {
                npc: {},
            /*
                dragon: {
                    "name": "Adult Black Dragon",
                    "settings": "size%3DHuge+%26semi%3B+variant%3D0+%26semi%3B+spellcasting%3D-+%26semi%3B+initAdv%3D0",
                    "type": "dragon",
                    "alignment": "chaotic evil",
                    "ac": "19 (natural armor)",
                    "hp": "195 (17d12 + 85)",
                    "speed": "40 ft., fly 80 ft., swim 40 ft.",
                    "str": 23,
                    "dex": 14,
                    "con": 21,
                    "int": 14,
                    "wis": 13,
                    "cha": 17,
                    "save": "Dex +7, Con +10, Wis +6, Cha +8",
                    "skill": "Perception +11, Stealth +7",
                    "DamageImmunities": "acid",
                    "senses": "blindsight 60 ft., darkvision 120 ft., passive Perception 21",
                    "languages": "Common, Draconic",
                    "challenge": "14 (11,500 XP)",
                    "feats": {
                        "Features": "***Amphibious.*** The dragon can breathe air and water.\n\n ***Legendary Resistance (3/Day).*** If the dragon fails a saving throw, it can choose to succeed instead."
                    },
                    "actions": {
                        "Actions": "***Multiattack.*** The dragon can use its Frightful Presence. It then makes three attacks: one with its bite and two with its claws.\n\n ***Bite.*** *Melee Weapon Attack:* [+11 to hit](to hit \"11\"), reach 10 ft., one target. *Hit:* [17 (2d10 + 6) piercing damage](roll \"2d10+6\") plus 4 (1d8) acid damage.\n\n ***Claw.*** *Melee Weapon Attack:* [+11 to hit](to hit \"11\"), reach 5 ft., one target. *Hit:* [13 (2d6 + 6) slashing damage](roll \"2d6+6\").\n\n ***Tail.*** *Melee Weapon Attack:* [+11 to hit](to hit \"11\"), reach 15 ft., one target. *Hit:* [15 (2d8 + 6) bludgeoning damage](roll \"2d8+6\").\n\n ***Frightful Presence.*** Each creature of the dragon's choice that is within 120 feet of the dragon and aware of it must succeed on a DC 16 Wisdom saving throw or become frightened for 1 minute. A creature can repeat the saving throw at the end of each of its turns, ending the effect on itself on a success. If a creature's saving throw is successful or the effect ends for it, the creature is immune to the dragon's Frightful Presence for the next 24 hours.\n\n ***Acid Breath (Recharge 5â€“6).*** The dragon exhales acid in a 60-foot line that is 5 feet wide. Each creature in that line must make a DC 18 Dexterity saving throw, taking [54 (12d8) acid damage](roll \"12d8\") on a failed save, or half as much damage on a successful one.",
                        "Legendary Actions": "The dragon can take 3 legendary actions, choosing from the options below. Only one legendary action option can be used at a time and only at the end of another creature's turn. The dragon regains spent legendary actions at the start of its turn.\n\n ***Detect.*** The dragon makes a Wisdom (Perception) check.\n\n ***Tail Attack.*** The dragon makes a tail attack.\n\n ***Wing Attack (Costs 2 Actions).*** The dragon beats its wings. Each creature within 10 feet of the dragon must succeed on a DC 19 Dexterity saving throw or take [13 (2d6 + 6) bludgeoning damage](roll \"2d6+6\") and be knocked prone. The dragon can then fly up to half its flying speed."
                    },
                    "sources": [
                        "SRD",
                        "MM"
                    ],
                    asset: "../assets/tokens/adult_blue_dragon.webp"
                }
            */
            }
        },

        methods: {

            getImage(name) {
                return `https://5e.tools/img/bestiary/tokens/MM/${name}.webp`;
            },

            parsePropertyList(encodedString) {
                return decodeURIComponent(encodedString.replace(/\+/g, ' '))
                    .replace(/&semi;/g, ';')
                    .split(';')
                    .reduce((obj, pair) => {
                        if (pair.trim()) {
                            let [key, value] = pair.split('=').map(str => str.trim());
                            obj[key] = isNaN(value) ? value : parseFloat(value);
                        }
                        return obj;
                    }, {});
            },

            getSize(settings) {
                const json = this.parsePropertyList(settings);
                return json.size;
            },

            hasValue(stat) {
                return !(stat == undefined || stat === 0 || stat === null);
            },

            getInitiative(npc) {
                let mod = Math.floor((npc.dex - 10) / 2);
                let score = 10 + mod;
                return `${mod >= 0 ? "+" : ""}${mod} (${score})`;
            },

            calcMod(score) {
                let mod = Math.floor((score - 10) / 2);
                return ` (${mod >= 0 ? "+" : ""}${mod})`;
            },

            calcProfBonus(challenge) {
                try {
                    if (challenge === undefined) return 0;

                    let rating = challenge.slice(0, challenge.indexOf(" "));
                    let base = Math.ceil(Number(eval(rating)) / 4);
                    if (base === 0)
                        base = 1;
                    let cr = "+" + (base + 1);
                    return cr;

                } catch (error) {
                    console.error(error);
                }
            },

            renderMarkdown(text) {
                if (text !== undefined)
                    return marked.parse(text);
            },

            async initialization() {
                try {
                    this.npc = await MT.getNpc("zombie");
                } catch (error) {
                    console.error(error);
                }
            }

        },

        async beforeMount() {
            await this.initialization();
        }
    }).mount('#app');
</script>

</html>